2025-10-26 11:42:12.622 +03:00 [DBG] Registered model binder providers, in the following order: ["Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BinderTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ServicesModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BodyModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.HeaderModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FloatingPointTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.EnumTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DateTimeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.SimpleTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.TryParseModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CancellationTokenModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ByteArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormFileModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormCollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.KeyValuePairModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DictionaryModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexObjectModelBinderProvider"]
2025-10-26 11:42:12.930 +03:00 [DBG] Hosting starting
2025-10-26 11:42:13.303 +03:00 [DBG] Starting bus instances: IBus
2025-10-26 11:42:13.314 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-10-26 11:42:13.361 +03:00 [DBG] Middleware loaded
2025-10-26 11:42:13.365 +03:00 [DBG] Middleware loaded. Script /_framework/aspnetcore-browser-refresh.js (16519 B).
2025-10-26 11:42:13.379 +03:00 [DBG] Middleware loaded. Script /_framework/blazor-hotreload.js (799 B).
2025-10-26 11:42:13.383 +03:00 [DBG] Connect: guest@localhost:5672/
2025-10-26 11:42:13.566 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 59536)
2025-10-26 11:42:13.644 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemAPI_bus_nbaoyyyh3bcsbtiebdxbe4hxnw?temporary=true"
2025-10-26 11:42:13.648 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-10-26 11:42:13.840 +03:00 [DBG] Middleware loaded: DOTNET_MODIFIABLE_ASSEMBLIES=debug, __ASPNETCORE_BROWSER_TOOLS=true
2025-10-26 11:42:14.089 +03:00 [INF] Now listening on: https://localhost:7257
2025-10-26 11:42:14.092 +03:00 [INF] Now listening on: http://localhost:5009
2025-10-26 11:42:14.094 +03:00 [DBG] Loaded hosting startup assembly BillingSystem.API
2025-10-26 11:42:14.096 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.ApiEndpointDiscovery
2025-10-26 11:42:14.099 +03:00 [DBG] Loaded hosting startup assembly Microsoft.AspNetCore.Watch.BrowserRefresh
2025-10-26 11:42:14.101 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.BrowserLink.Net
2025-10-26 11:42:14.225 +03:00 [DBG] Connection id "0HNGKDE7V3VGS" accepted.
2025-10-26 11:42:14.228 +03:00 [DBG] Connection id "0HNGKDE7V3VGS" received FIN.
2025-10-26 11:42:14.230 +03:00 [DBG] Connection id "0HNGKDE7V3VGS" started.
2025-10-26 11:42:14.247 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-10-26 11:42:14.250 +03:00 [INF] Hosting environment: Development
2025-10-26 11:42:14.251 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.API
2025-10-26 11:42:14.254 +03:00 [DBG] Hosting started
2025-10-26 11:42:14.253 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 11:42:14.333 +03:00 [DBG] Connection id "0HNGKDE7V3VGS" stopped.
2025-10-26 11:42:14.346 +03:00 [DBG] Connection id "0HNGKDE7V3VGS" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 11:42:16.561 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" accepted.
2025-10-26 11:42:16.568 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" started.
2025-10-26 11:42:16.649 +03:00 [DBG] Connection 0HNGKDE7V3VGT established using the following protocol: "Tls13"
2025-10-26 11:42:16.772 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/index.html - null null
2025-10-26 11:42:16.909 +03:00 [DBG] Wildcard detected, all requests with hosts will be allowed.
2025-10-26 11:42:16.934 +03:00 [DBG] No candidates found for the request path '/swagger/index.html'
2025-10-26 11:42:16.937 +03:00 [DBG] Request did not match any endpoints
2025-10-26 11:42:17.014 +03:00 [DBG] Response markup is scheduled to include Browser Link script injection.
2025-10-26 11:42:17.021 +03:00 [DBG] Response markup is scheduled to include browser refresh script injection.
2025-10-26 11:42:17.051 +03:00 [INF] HTTP GET /swagger/index.html responded 200 in 104.3527 ms
2025-10-26 11:42:17.061 +03:00 [DBG] Response markup was updated to include Browser Link script injection.
2025-10-26 11:42:17.073 +03:00 [DBG] Response markup was updated to include browser refresh script injection.
2025-10-26 11:42:17.091 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/index.html - 200 null text/html;charset=utf-8 326.7301ms
2025-10-26 11:42:17.240 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - null null
2025-10-26 11:42:17.254 +03:00 [DBG] Script injected: /_framework/aspnetcore-browser-refresh.js
2025-10-26 11:42:17.257 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - 200 16519 application/javascript; charset=utf-8 17.1402ms
2025-10-26 11:42:17.287 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_vs/browserLink - null null
2025-10-26 11:42:17.350 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_vs/browserLink - 200 null text/javascript; charset=UTF-8 64.303ms
2025-10-26 11:42:17.435 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - null null
2025-10-26 11:42:17.442 +03:00 [DBG] No candidates found for the request path '/swagger/v1/swagger.json'
2025-10-26 11:42:17.446 +03:00 [DBG] Request did not match any endpoints
2025-10-26 11:42:17.460 +03:00 [INF] HTTP GET /swagger/v1/swagger.json responded 200 in 10.8101 ms
2025-10-26 11:42:17.469 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 34.876ms
2025-10-26 11:47:05.333 +03:00 [DBG] Connection id "0HNGKDE7V3VGU" accepted.
2025-10-26 11:47:05.334 +03:00 [DBG] Connection id "0HNGKDE7V3VGU" received FIN.
2025-10-26 11:47:05.348 +03:00 [DBG] Connection id "0HNGKDE7V3VGU" started.
2025-10-26 11:47:05.350 +03:00 [DBG] Connection id "0HNGKDE7V3VGV" accepted.
2025-10-26 11:47:05.360 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 11:47:05.361 +03:00 [DBG] Connection id "0HNGKDE7V3VGV" started.
2025-10-26 11:47:05.365 +03:00 [DBG] Connection id "0HNGKDE7V3VGU" stopped.
2025-10-26 11:47:05.369 +03:00 [DBG] Connection id "0HNGKDE7V3VGU" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 11:47:05.373 +03:00 [DBG] Connection 0HNGKDE7V3VGV established using the following protocol: "Tls13"
2025-10-26 11:47:05.383 +03:00 [INF] Request starting HTTP/1.1 POST https://localhost:7257/api/Invoices - application/json 262
2025-10-26 11:47:05.395 +03:00 [DBG] 1 candidate(s) found for the request path '/api/Invoices'
2025-10-26 11:47:05.406 +03:00 [DBG] Endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)' with route pattern 'api/Invoices' is valid for the request path '/api/Invoices'
2025-10-26 11:47:05.411 +03:00 [DBG] Request matched endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 11:47:05.422 +03:00 [DBG] Static files was skipped as the request already matched an endpoint.
2025-10-26 11:47:05.904 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-10-26 11:47:11.627 +03:00 [INF] Executing endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 11:47:11.667 +03:00 [INF] Route matched with {action = "Post", controller = "Invoices"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Post(BillingSystem.Application.Requests.CreateInvoiceRequest) on controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API).
2025-10-26 11:47:11.674 +03:00 [DBG] Execution plan of authorization filters (in the following order): ["None"]
2025-10-26 11:47:11.678 +03:00 [DBG] Execution plan of resource filters (in the following order): ["None"]
2025-10-26 11:47:11.682 +03:00 [DBG] Execution plan of action filters (in the following order): ["Microsoft.AspNetCore.Mvc.ModelBinding.UnsupportedContentTypeFilter (Order: -3000)","Microsoft.AspNetCore.Mvc.Infrastructure.ModelStateInvalidFilter (Order: -2000)","BillingSystem.API.ActionFilters.AuditBillingRequestsFilter","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 11:47:11.687 +03:00 [DBG] Execution plan of exception filters (in the following order): ["None"]
2025-10-26 11:47:11.691 +03:00 [DBG] Execution plan of result filters (in the following order): ["Microsoft.AspNetCore.Mvc.Infrastructure.ClientErrorResultFilter (Order: -2000)","Microsoft.AspNetCore.Mvc.ProducesAttribute (Order: 0)","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 11:47:11.697 +03:00 [DBG] Executing controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 11:47:11.705 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software MediatR. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 11:47:11.742 +03:00 [DBG] Executed controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 11:47:11.833 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 11:47:11.845 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' using the name '' in request data ...
2025-10-26 11:47:11.854 +03:00 [DBG] Selected input formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonInputFormatter' for content type 'application/json'.
2025-10-26 11:47:11.903 +03:00 [DBG] Connection id "0HNGKDE7V3VGV", Request id "0HNGKDE7V3VGV:00000001": started reading request body.
2025-10-26 11:47:11.909 +03:00 [DBG] Connection id "0HNGKDE7V3VGV", Request id "0HNGKDE7V3VGV:00000001": done reading request body.
2025-10-26 11:47:11.932 +03:00 [DBG] JSON input formatter succeeded, deserializing to type 'BillingSystem.Application.Requests.CreateInvoiceRequest'
2025-10-26 11:47:11.936 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 11:47:11.939 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 11:47:11.943 +03:00 [DBG] Attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 11:47:11.970 +03:00 [DBG] Done attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 11:47:12.818 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-10-26 11:47:13.032 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .AsNoTracking()
    .Any(inv => inv.ExternalId.ToString() == __idempotentKey_0)'
2025-10-26 11:47:13.354 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<bool>(
    asyncEnumerable: SingleQueryingEnumerable.Create<bool>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0)) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0), 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            bool? value1;
            value1 = dataReader.IsDBNull(0) ? default(bool?) : (bool?)dataReader.GetBoolean(0);
            return (bool)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 11:47:13.420 +03:00 [DBG] Creating DbConnection.
2025-10-26 11:47:13.447 +03:00 [DBG] Created DbConnection. (24ms).
2025-10-26 11:47:13.452 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 11:47:14.047 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 11:47:14.054 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 11:47:14.064 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (6ms).
2025-10-26 11:47:14.077 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (22ms).
2025-10-26 11:47:14.092 +03:00 [DBG] Executing DbCommand [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 11:47:14.269 +03:00 [INF] Executed DbCommand (176ms) [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 11:47:14.304 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-10-26 11:47:14.317 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 32ms reading results.
2025-10-26 11:47:14.325 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 11:47:14.337 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (11ms).
2025-10-26 11:47:14.510 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software AutoMapper. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 11:47:48.038 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" received FIN.
2025-10-26 11:47:48.393 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" is closed. The last processed stream ID was 7.
2025-10-26 11:47:48.404 +03:00 [DBG] The connection queue processing loop for 0HNGKDE7V3VGT completed.
2025-10-26 11:47:48.413 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 11:47:48.934 +03:00 [DBG] Connection id "0HNGKDE7V3VGT" stopped.
2025-10-26 11:48:16.610 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 11:48:16.615 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 11:48:16.620 +03:00 [DBG] Beginning transaction with isolation level 'Unspecified'.
2025-10-26 11:48:16.631 +03:00 [DBG] Began transaction with isolation level 'ReadCommitted'.
2025-10-26 11:48:19.983 +03:00 [DBG] Compiling query expression: 
'SqlQuery<int>(SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence, __p_0)
    .Single()'
2025-10-26 11:48:19.999 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<int>(
    asyncEnumerable: SingleQueryingEnumerable.Create<int>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(2) s.Value
            FROM SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(2) s.Value
            FROM SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence, 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            int? value1;
            value1 = dataReader.IsDBNull(0) ? default(int?) : (int?)dataReader.GetInt32(0);
            return (int)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 11:48:20.017 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 11:48:20.021 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (3ms).
2025-10-26 11:48:20.028 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (10ms).
2025-10-26 11:48:20.031 +03:00 [DBG] Executing DbCommand [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [s].[Value]
FROM (
    SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence
) AS [s]
2025-10-26 11:48:20.069 +03:00 [ERR] Failed executing DbCommand (37ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [s].[Value]
FROM (
    SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence
) AS [s]
2025-10-26 11:48:20.088 +03:00 [ERR] An exception occurred while iterating over the results of a query for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:45b34ad0-429f-4430-aebc-3f0479772e8f
Error Number:11719,State:1,Class:15
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:45b34ad0-429f-4430-aebc-3f0479772e8f
Error Number:11719,State:1,Class:15
2025-10-26 12:13:05.037 +03:00 [DBG] Registered model binder providers, in the following order: ["Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BinderTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ServicesModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BodyModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.HeaderModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FloatingPointTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.EnumTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DateTimeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.SimpleTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.TryParseModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CancellationTokenModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ByteArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormFileModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormCollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.KeyValuePairModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DictionaryModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexObjectModelBinderProvider"]
2025-10-26 12:13:05.231 +03:00 [DBG] Hosting starting
2025-10-26 12:13:05.608 +03:00 [DBG] Starting bus instances: IBus
2025-10-26 12:13:05.616 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-10-26 12:13:05.641 +03:00 [DBG] Middleware loaded
2025-10-26 12:13:05.647 +03:00 [DBG] Middleware loaded. Script /_framework/aspnetcore-browser-refresh.js (16519 B).
2025-10-26 12:13:05.658 +03:00 [DBG] Middleware loaded. Script /_framework/blazor-hotreload.js (799 B).
2025-10-26 12:13:05.665 +03:00 [DBG] Connect: guest@localhost:5672/
2025-10-26 12:13:05.801 +03:00 [DBG] Middleware loaded: DOTNET_MODIFIABLE_ASSEMBLIES=debug, __ASPNETCORE_BROWSER_TOOLS=true
2025-10-26 12:13:05.836 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 56282)
2025-10-26 12:13:05.918 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemAPI_bus_obtyyyyh3bcsbyexbdxbe569de?temporary=true"
2025-10-26 12:13:05.928 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-10-26 12:13:06.129 +03:00 [INF] Now listening on: https://localhost:7257
2025-10-26 12:13:06.132 +03:00 [INF] Now listening on: http://localhost:5009
2025-10-26 12:13:06.136 +03:00 [DBG] Loaded hosting startup assembly BillingSystem.API
2025-10-26 12:13:06.138 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.ApiEndpointDiscovery
2025-10-26 12:13:06.141 +03:00 [DBG] Loaded hosting startup assembly Microsoft.AspNetCore.Watch.BrowserRefresh
2025-10-26 12:13:06.143 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.BrowserLink.Net
2025-10-26 12:13:06.266 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-10-26 12:13:06.269 +03:00 [INF] Hosting environment: Development
2025-10-26 12:13:06.272 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.API
2025-10-26 12:13:06.276 +03:00 [DBG] Hosting started
2025-10-26 12:13:06.449 +03:00 [DBG] Connection id "0HNGKDVFV9QB8" accepted.
2025-10-26 12:13:06.454 +03:00 [DBG] Connection id "0HNGKDVFV9QB8" started.
2025-10-26 12:13:06.461 +03:00 [DBG] Connection id "0HNGKDVFV9QB9" accepted.
2025-10-26 12:13:06.469 +03:00 [DBG] Connection id "0HNGKDVFV9QB9" started.
2025-10-26 12:13:06.482 +03:00 [DBG] Connection id "0HNGKDVFV9QB8" received FIN.
2025-10-26 12:13:06.482 +03:00 [DBG] Connection id "0HNGKDVFV9QB9" received FIN.
2025-10-26 12:13:06.511 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 12:13:06.511 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 12:13:06.546 +03:00 [DBG] Connection id "0HNGKDVFV9QB8" stopped.
2025-10-26 12:13:06.547 +03:00 [DBG] Connection id "0HNGKDVFV9QB9" stopped.
2025-10-26 12:13:06.558 +03:00 [DBG] Connection id "0HNGKDVFV9QB9" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 12:13:06.558 +03:00 [DBG] Connection id "0HNGKDVFV9QB8" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 12:13:07.051 +03:00 [DBG] Connection id "0HNGKDVFV9QBA" accepted.
2025-10-26 12:13:07.054 +03:00 [DBG] Connection id "0HNGKDVFV9QBA" started.
2025-10-26 12:13:07.111 +03:00 [DBG] Connection 0HNGKDVFV9QBA established using the following protocol: "Tls13"
2025-10-26 12:13:07.205 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/index.html - null null
2025-10-26 12:13:07.252 +03:00 [DBG] Wildcard detected, all requests with hosts will be allowed.
2025-10-26 12:13:07.273 +03:00 [DBG] No candidates found for the request path '/swagger/index.html'
2025-10-26 12:13:07.277 +03:00 [DBG] Request did not match any endpoints
2025-10-26 12:13:07.355 +03:00 [DBG] Response markup is scheduled to include Browser Link script injection.
2025-10-26 12:13:07.360 +03:00 [DBG] Response markup is scheduled to include browser refresh script injection.
2025-10-26 12:13:07.394 +03:00 [INF] HTTP GET /swagger/index.html responded 200 in 106.8325 ms
2025-10-26 12:13:07.406 +03:00 [DBG] Response markup was updated to include Browser Link script injection.
2025-10-26 12:13:07.409 +03:00 [DBG] Response markup was updated to include browser refresh script injection.
2025-10-26 12:13:07.420 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/index.html - 200 null text/html;charset=utf-8 220.8938ms
2025-10-26 12:13:07.420 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - null null
2025-10-26 12:13:07.442 +03:00 [DBG] Script injected: /_framework/aspnetcore-browser-refresh.js
2025-10-26 12:13:07.447 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - 200 16519 application/javascript; charset=utf-8 26.8734ms
2025-10-26 12:13:07.460 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_vs/browserLink - null null
2025-10-26 12:13:07.515 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_vs/browserLink - 200 null text/javascript; charset=UTF-8 56.0857ms
2025-10-26 12:13:07.605 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - null null
2025-10-26 12:13:07.613 +03:00 [DBG] No candidates found for the request path '/swagger/v1/swagger.json'
2025-10-26 12:13:07.615 +03:00 [DBG] Request did not match any endpoints
2025-10-26 12:13:07.633 +03:00 [INF] HTTP GET /swagger/v1/swagger.json responded 200 in 14.6034 ms
2025-10-26 12:13:07.640 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 34.6497ms
2025-10-26 12:13:23.191 +03:00 [DBG] Connection id "0HNGKDVFV9QBB" accepted.
2025-10-26 12:13:23.191 +03:00 [DBG] Connection id "0HNGKDVFV9QBB" received FIN.
2025-10-26 12:13:23.196 +03:00 [DBG] Connection id "0HNGKDVFV9QBB" started.
2025-10-26 12:13:23.197 +03:00 [DBG] Connection id "0HNGKDVFV9QBC" accepted.
2025-10-26 12:13:23.202 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 12:13:23.203 +03:00 [DBG] Connection id "0HNGKDVFV9QBC" started.
2025-10-26 12:13:23.208 +03:00 [DBG] Connection id "0HNGKDVFV9QBB" stopped.
2025-10-26 12:13:23.212 +03:00 [DBG] Connection id "0HNGKDVFV9QBB" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 12:13:23.215 +03:00 [DBG] Connection 0HNGKDVFV9QBC established using the following protocol: "Tls13"
2025-10-26 12:13:23.222 +03:00 [INF] Request starting HTTP/1.1 POST https://localhost:7257/api/Invoices - application/json 262
2025-10-26 12:13:23.233 +03:00 [DBG] 1 candidate(s) found for the request path '/api/Invoices'
2025-10-26 12:13:23.239 +03:00 [DBG] Endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)' with route pattern 'api/Invoices' is valid for the request path '/api/Invoices'
2025-10-26 12:13:23.243 +03:00 [DBG] Request matched endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 12:13:23.250 +03:00 [DBG] Static files was skipped as the request already matched an endpoint.
2025-10-26 12:13:23.399 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-10-26 12:13:28.835 +03:00 [INF] Executing endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 12:13:28.889 +03:00 [INF] Route matched with {action = "Post", controller = "Invoices"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Post(BillingSystem.Application.Requests.CreateInvoiceRequest) on controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API).
2025-10-26 12:13:28.899 +03:00 [DBG] Execution plan of authorization filters (in the following order): ["None"]
2025-10-26 12:13:28.903 +03:00 [DBG] Execution plan of resource filters (in the following order): ["None"]
2025-10-26 12:13:28.906 +03:00 [DBG] Execution plan of action filters (in the following order): ["Microsoft.AspNetCore.Mvc.ModelBinding.UnsupportedContentTypeFilter (Order: -3000)","Microsoft.AspNetCore.Mvc.Infrastructure.ModelStateInvalidFilter (Order: -2000)","BillingSystem.API.ActionFilters.AuditBillingRequestsFilter","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 12:13:28.913 +03:00 [DBG] Execution plan of exception filters (in the following order): ["None"]
2025-10-26 12:13:28.916 +03:00 [DBG] Execution plan of result filters (in the following order): ["Microsoft.AspNetCore.Mvc.Infrastructure.ClientErrorResultFilter (Order: -2000)","Microsoft.AspNetCore.Mvc.ProducesAttribute (Order: 0)","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 12:13:28.924 +03:00 [DBG] Executing controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 12:13:28.934 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software MediatR. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 12:13:28.979 +03:00 [DBG] Executed controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 12:13:29.004 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 12:13:29.013 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' using the name '' in request data ...
2025-10-26 12:13:29.022 +03:00 [DBG] Selected input formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonInputFormatter' for content type 'application/json'.
2025-10-26 12:13:29.066 +03:00 [DBG] Connection id "0HNGKDVFV9QBC", Request id "0HNGKDVFV9QBC:00000001": started reading request body.
2025-10-26 12:13:29.072 +03:00 [DBG] Connection id "0HNGKDVFV9QBC", Request id "0HNGKDVFV9QBC:00000001": done reading request body.
2025-10-26 12:13:29.114 +03:00 [DBG] JSON input formatter succeeded, deserializing to type 'BillingSystem.Application.Requests.CreateInvoiceRequest'
2025-10-26 12:13:29.120 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 12:13:29.123 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 12:13:29.126 +03:00 [DBG] Attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 12:13:29.154 +03:00 [DBG] Done attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 12:13:29.841 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-10-26 12:13:29.956 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .AsNoTracking()
    .Any(inv => inv.ExternalId.ToString() == __idempotentKey_0)'
2025-10-26 12:13:30.240 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<bool>(
    asyncEnumerable: SingleQueryingEnumerable.Create<bool>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0)) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0), 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            bool? value1;
            value1 = dataReader.IsDBNull(0) ? default(bool?) : (bool?)dataReader.GetBoolean(0);
            return (bool)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 12:13:30.301 +03:00 [DBG] Creating DbConnection.
2025-10-26 12:13:30.334 +03:00 [DBG] Created DbConnection. (28ms).
2025-10-26 12:13:30.345 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 12:13:30.646 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 12:13:30.654 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 12:13:30.665 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (6ms).
2025-10-26 12:13:30.675 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (21ms).
2025-10-26 12:13:30.689 +03:00 [DBG] Executing DbCommand [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 12:13:30.761 +03:00 [INF] Executed DbCommand (75ms) [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 12:13:30.785 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-10-26 12:13:30.797 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 23ms reading results.
2025-10-26 12:13:30.804 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 12:13:30.814 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (9ms).
2025-10-26 12:13:30.932 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software AutoMapper. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 12:13:45.254 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 12:13:45.267 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 12:13:45.274 +03:00 [DBG] Beginning transaction with isolation level 'Unspecified'.
2025-10-26 12:13:45.288 +03:00 [DBG] Began transaction with isolation level 'ReadCommitted'.
2025-10-26 12:13:47.047 +03:00 [DBG] Compiling query expression: 
'SqlQuery<long>(SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence, __p_0)
    .First()'
2025-10-26 12:13:47.058 +03:00 [WRN] The query uses the 'First'/'FirstOrDefault' operator without 'OrderBy' and filter operators. This may lead to unpredictable results.
2025-10-26 12:13:47.068 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<long>(
    asyncEnumerable: SingleQueryingEnumerable.Create<long>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence, 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            long? value1;
            value1 = dataReader.IsDBNull(0) ? default(long?) : (long?)dataReader.GetInt64(0);
            return (long)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 12:13:47.086 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 12:13:47.092 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (5ms).
2025-10-26 12:13:47.097 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (11ms).
2025-10-26 12:13:47.100 +03:00 [DBG] Executing DbCommand [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence
) AS [s]
2025-10-26 12:13:47.136 +03:00 [ERR] Failed executing DbCommand (34ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT NEXT VALUE FOR dbo.InvoiceNumberSequence
) AS [s]
2025-10-26 12:13:47.154 +03:00 [ERR] An exception occurred while iterating over the results of a query for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:b676def5-cded-4995-9cb3-5fe3e1b465e7
Error Number:11719,State:1,Class:15
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:b676def5-cded-4995-9cb3-5fe3e1b465e7
Error Number:11719,State:1,Class:15
2025-10-26 13:48:32.135 +03:00 [DBG] Registered model binder providers, in the following order: ["Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BinderTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ServicesModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BodyModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.HeaderModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FloatingPointTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.EnumTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DateTimeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.SimpleTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.TryParseModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CancellationTokenModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ByteArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormFileModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormCollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.KeyValuePairModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DictionaryModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexObjectModelBinderProvider"]
2025-10-26 13:48:32.310 +03:00 [DBG] Hosting starting
2025-10-26 13:48:32.726 +03:00 [DBG] Starting bus instances: IBus
2025-10-26 13:48:32.733 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-10-26 13:48:32.761 +03:00 [DBG] Middleware loaded
2025-10-26 13:48:32.765 +03:00 [DBG] Middleware loaded. Script /_framework/aspnetcore-browser-refresh.js (16519 B).
2025-10-26 13:48:32.777 +03:00 [DBG] Middleware loaded. Script /_framework/blazor-hotreload.js (799 B).
2025-10-26 13:48:32.783 +03:00 [DBG] Connect: guest@localhost:5672/
2025-10-26 13:48:32.930 +03:00 [DBG] Middleware loaded: DOTNET_MODIFIABLE_ASSEMBLIES=debug, __ASPNETCORE_BROWSER_TOOLS=true
2025-10-26 13:48:32.952 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 53337)
2025-10-26 13:48:33.016 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemAPI_bus_cbhoyyyh3bcsb5nwbdxbe9jiyr?temporary=true"
2025-10-26 13:48:33.021 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-10-26 13:48:33.198 +03:00 [INF] Now listening on: https://localhost:7257
2025-10-26 13:48:33.203 +03:00 [INF] Now listening on: http://localhost:5009
2025-10-26 13:48:33.207 +03:00 [DBG] Loaded hosting startup assembly BillingSystem.API
2025-10-26 13:48:33.209 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.ApiEndpointDiscovery
2025-10-26 13:48:33.211 +03:00 [DBG] Loaded hosting startup assembly Microsoft.AspNetCore.Watch.BrowserRefresh
2025-10-26 13:48:33.214 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.BrowserLink.Net
2025-10-26 13:48:33.339 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-10-26 13:48:33.341 +03:00 [INF] Hosting environment: Development
2025-10-26 13:48:33.343 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.API
2025-10-26 13:48:33.346 +03:00 [DBG] Hosting started
2025-10-26 13:48:33.424 +03:00 [DBG] Connection id "0HNGKFKQNVOTV" accepted.
2025-10-26 13:48:33.424 +03:00 [DBG] Connection id "0HNGKFKQNVOU0" accepted.
2025-10-26 13:48:33.429 +03:00 [DBG] Connection id "0HNGKFKQNVOTV" started.
2025-10-26 13:48:33.431 +03:00 [DBG] Connection id "0HNGKFKQNVOU0" started.
2025-10-26 13:48:33.442 +03:00 [DBG] Connection id "0HNGKFKQNVOTV" received FIN.
2025-10-26 13:48:33.442 +03:00 [DBG] Connection id "0HNGKFKQNVOU0" received FIN.
2025-10-26 13:48:33.465 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 13:48:33.465 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 13:48:33.498 +03:00 [DBG] Connection id "0HNGKFKQNVOU0" stopped.
2025-10-26 13:48:33.499 +03:00 [DBG] Connection id "0HNGKFKQNVOTV" stopped.
2025-10-26 13:48:33.509 +03:00 [DBG] Connection id "0HNGKFKQNVOTV" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 13:48:33.509 +03:00 [DBG] Connection id "0HNGKFKQNVOU0" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 13:48:34.002 +03:00 [DBG] Connection id "0HNGKFKQNVOU1" accepted.
2025-10-26 13:48:34.005 +03:00 [DBG] Connection id "0HNGKFKQNVOU1" started.
2025-10-26 13:48:34.063 +03:00 [DBG] Connection 0HNGKFKQNVOU1 established using the following protocol: "Tls13"
2025-10-26 13:48:34.146 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/index.html - null null
2025-10-26 13:48:34.215 +03:00 [DBG] Wildcard detected, all requests with hosts will be allowed.
2025-10-26 13:48:34.237 +03:00 [DBG] No candidates found for the request path '/swagger/index.html'
2025-10-26 13:48:34.243 +03:00 [DBG] Request did not match any endpoints
2025-10-26 13:48:34.326 +03:00 [DBG] Response markup is scheduled to include Browser Link script injection.
2025-10-26 13:48:34.330 +03:00 [DBG] Response markup is scheduled to include browser refresh script injection.
2025-10-26 13:48:34.358 +03:00 [INF] HTTP GET /swagger/index.html responded 200 in 103.5795 ms
2025-10-26 13:48:34.366 +03:00 [DBG] Response markup was updated to include Browser Link script injection.
2025-10-26 13:48:34.369 +03:00 [DBG] Response markup was updated to include browser refresh script injection.
2025-10-26 13:48:34.387 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/index.html - 200 null text/html;charset=utf-8 253.9864ms
2025-10-26 13:48:34.411 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - null null
2025-10-26 13:48:34.426 +03:00 [DBG] Script injected: /_framework/aspnetcore-browser-refresh.js
2025-10-26 13:48:34.432 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - 200 16519 application/javascript; charset=utf-8 20.7265ms
2025-10-26 13:48:34.440 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_vs/browserLink - null null
2025-10-26 13:48:34.504 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_vs/browserLink - 200 null text/javascript; charset=UTF-8 64.4516ms
2025-10-26 13:48:34.546 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - null null
2025-10-26 13:48:34.552 +03:00 [DBG] No candidates found for the request path '/swagger/v1/swagger.json'
2025-10-26 13:48:34.555 +03:00 [DBG] Request did not match any endpoints
2025-10-26 13:48:34.566 +03:00 [INF] HTTP GET /swagger/v1/swagger.json responded 200 in 8.1914 ms
2025-10-26 13:48:34.571 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 25.1943ms
2025-10-26 13:49:38.602 +03:00 [DBG] Connection id "0HNGKFKQNVOU2" accepted.
2025-10-26 13:49:38.602 +03:00 [DBG] Connection id "0HNGKFKQNVOU2" received FIN.
2025-10-26 13:49:38.610 +03:00 [DBG] Connection id "0HNGKFKQNVOU3" accepted.
2025-10-26 13:49:38.609 +03:00 [DBG] Connection id "0HNGKFKQNVOU2" started.
2025-10-26 13:49:38.633 +03:00 [DBG] Connection id "0HNGKFKQNVOU3" started.
2025-10-26 13:49:38.636 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 13:49:38.642 +03:00 [DBG] Connection id "0HNGKFKQNVOU2" stopped.
2025-10-26 13:49:38.645 +03:00 [DBG] Connection id "0HNGKFKQNVOU2" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 13:49:38.646 +03:00 [DBG] Connection 0HNGKFKQNVOU3 established using the following protocol: "Tls13"
2025-10-26 13:49:38.658 +03:00 [INF] Request starting HTTP/1.1 POST https://localhost:7257/api/Invoices - application/json 262
2025-10-26 13:49:38.669 +03:00 [DBG] 1 candidate(s) found for the request path '/api/Invoices'
2025-10-26 13:49:38.680 +03:00 [DBG] Endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)' with route pattern 'api/Invoices' is valid for the request path '/api/Invoices'
2025-10-26 13:49:38.685 +03:00 [DBG] Request matched endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 13:49:38.693 +03:00 [DBG] Static files was skipped as the request already matched an endpoint.
2025-10-26 13:49:38.928 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-10-26 13:49:44.371 +03:00 [INF] Executing endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 13:49:44.422 +03:00 [INF] Route matched with {action = "Post", controller = "Invoices"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Post(BillingSystem.Application.Requests.CreateInvoiceRequest) on controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API).
2025-10-26 13:49:44.430 +03:00 [DBG] Execution plan of authorization filters (in the following order): ["None"]
2025-10-26 13:49:44.434 +03:00 [DBG] Execution plan of resource filters (in the following order): ["None"]
2025-10-26 13:49:44.439 +03:00 [DBG] Execution plan of action filters (in the following order): ["Microsoft.AspNetCore.Mvc.ModelBinding.UnsupportedContentTypeFilter (Order: -3000)","Microsoft.AspNetCore.Mvc.Infrastructure.ModelStateInvalidFilter (Order: -2000)","BillingSystem.API.ActionFilters.AuditBillingRequestsFilter","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 13:49:44.444 +03:00 [DBG] Execution plan of exception filters (in the following order): ["None"]
2025-10-26 13:49:44.448 +03:00 [DBG] Execution plan of result filters (in the following order): ["Microsoft.AspNetCore.Mvc.Infrastructure.ClientErrorResultFilter (Order: -2000)","Microsoft.AspNetCore.Mvc.ProducesAttribute (Order: 0)","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 13:49:44.455 +03:00 [DBG] Executing controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 13:49:44.465 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software MediatR. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 13:49:44.507 +03:00 [DBG] Executed controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 13:49:44.530 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 13:49:44.538 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' using the name '' in request data ...
2025-10-26 13:49:44.542 +03:00 [DBG] Selected input formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonInputFormatter' for content type 'application/json'.
2025-10-26 13:49:44.579 +03:00 [DBG] Connection id "0HNGKFKQNVOU3", Request id "0HNGKFKQNVOU3:00000001": started reading request body.
2025-10-26 13:49:44.584 +03:00 [DBG] Connection id "0HNGKFKQNVOU3", Request id "0HNGKFKQNVOU3:00000001": done reading request body.
2025-10-26 13:49:44.625 +03:00 [DBG] JSON input formatter succeeded, deserializing to type 'BillingSystem.Application.Requests.CreateInvoiceRequest'
2025-10-26 13:49:44.630 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 13:49:44.634 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 13:49:44.640 +03:00 [DBG] Attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 13:49:44.665 +03:00 [DBG] Done attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 13:49:45.346 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-10-26 13:49:45.468 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .AsNoTracking()
    .Any(inv => inv.ExternalId.ToString() == __idempotentKey_0)'
2025-10-26 13:49:45.752 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<bool>(
    asyncEnumerable: SingleQueryingEnumerable.Create<bool>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0)) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0), 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            bool? value1;
            value1 = dataReader.IsDBNull(0) ? default(bool?) : (bool?)dataReader.GetBoolean(0);
            return (bool)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 13:49:45.827 +03:00 [DBG] Creating DbConnection.
2025-10-26 13:49:45.855 +03:00 [DBG] Created DbConnection. (23ms).
2025-10-26 13:49:45.868 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:49:46.258 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:49:46.266 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 13:49:46.283 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (11ms).
2025-10-26 13:49:46.299 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (34ms).
2025-10-26 13:49:46.317 +03:00 [DBG] Executing DbCommand [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 13:49:46.419 +03:00 [INF] Executed DbCommand (104ms) [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 13:49:46.446 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-10-26 13:49:46.462 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 31ms reading results.
2025-10-26 13:49:46.471 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:49:46.481 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (10ms).
2025-10-26 13:49:46.609 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software AutoMapper. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 13:50:11.659 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:50:11.667 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:50:11.675 +03:00 [DBG] Beginning transaction with isolation level 'Unspecified'.
2025-10-26 13:50:11.689 +03:00 [DBG] Began transaction with isolation level 'ReadCommitted'.
2025-10-26 13:50:12.841 +03:00 [DBG] Compiling query expression: 
'SqlQuery<long>(SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value, __p_0)
    .First()'
2025-10-26 13:50:12.850 +03:00 [WRN] The query uses the 'First'/'FirstOrDefault' operator without 'OrderBy' and filter operators. This may lead to unpredictable results.
2025-10-26 13:50:12.859 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<long>(
    asyncEnumerable: SingleQueryingEnumerable.Create<long>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value, 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            long? value1;
            value1 = dataReader.IsDBNull(0) ? default(long?) : (long?)dataReader.GetInt64(0);
            return (long)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 13:50:12.871 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 13:50:12.876 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (5ms).
2025-10-26 13:50:12.882 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (10ms).
2025-10-26 13:50:12.885 +03:00 [DBG] Executing DbCommand [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value
) AS [s]
2025-10-26 13:50:12.925 +03:00 [ERR] Failed executing DbCommand (39ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value
) AS [s]
2025-10-26 13:50:12.941 +03:00 [ERR] An exception occurred while iterating over the results of a query for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:af070f96-d7da-416c-adc6-702b7e88a382
Error Number:11719,State:1,Class:15
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:af070f96-d7da-416c-adc6-702b7e88a382
Error Number:11719,State:1,Class:15
2025-10-26 13:52:51.089 +03:00 [ERR] exception occured NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements. , stackTrace    at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Insert(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 60
2025-10-26 13:52:51.113 +03:00 [DBG] Disconnect: guest@localhost:5672/
2025-10-26 13:52:51.133 +03:00 [DBG] Rolling back transaction.
2025-10-26 13:52:51.162 +03:00 [DBG] Rolled back transaction.
2025-10-26 13:52:51.166 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:52:51.170 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (3ms).
2025-10-26 13:52:51.174 +03:00 [DBG] Disconnected: guest@localhost:5672/
2025-10-26 13:52:51.202 +03:00 [DBG] Disposing transaction.
2025-10-26 13:52:51.266 +03:00 [ERR] exception occured NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements. , stackTrace    at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Insert(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 60
   at BillingSystem.Application.Commands.CreateInvoiceCommandRequestHandler.Handle(CreateInvoiceRequest request, CancellationToken cancellationToken) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Application\Commands\CreateInvoiceCommandRequestHandler.cs:line 39
   at BillingSystem.API.Controllers.InvoicesController.Post(CreateInvoiceRequest invoiceRequest) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.API\Controllers\InvoicesController.cs:line 45
2025-10-26 13:52:51.304 +03:00 [DBG] List of registered output formatters, in the following order: ["Microsoft.AspNetCore.Mvc.Formatters.HttpNoContentOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.StringOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.StreamOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonOutputFormatter"]
2025-10-26 13:52:51.314 +03:00 [DBG] No information found on request to perform content negotiation.
2025-10-26 13:52:51.319 +03:00 [DBG] Attempting to select the first output formatter in the output formatters list which supports a content type from the explicitly specified content types '["application/json","application/problem+json","application/problem+xml"]'.
2025-10-26 13:52:51.327 +03:00 [DBG] Selected output formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonOutputFormatter' and content type 'application/json' to write the response.
2025-10-26 13:52:51.331 +03:00 [INF] Executing ObjectResult, writing value of type 'Microsoft.AspNetCore.Mvc.ProblemDetails'.
2025-10-26 13:52:51.370 +03:00 [INF] Executed action BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API) in 186911.4968ms
2025-10-26 13:52:51.375 +03:00 [INF] Executed endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 13:52:51.379 +03:00 [ERR] HTTP POST /api/Invoices responded 500 in 192688.0557 ms
2025-10-26 13:52:51.385 +03:00 [DBG] Connection id "0HNGKFKQNVOU3" completed keep alive response.
2025-10-26 13:52:51.391 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-10-26 13:52:51.399 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 13:52:51.403 +03:00 [DBG] Disposed connection to database '' on server '' (4ms).
2025-10-26 13:52:51.406 +03:00 [INF] Request finished HTTP/1.1 POST https://localhost:7257/api/Invoices - 500 null application/json; charset=utf-8 192747.9032ms
2025-10-26 14:04:46.152 +03:00 [DBG] Registered model binder providers, in the following order: ["Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BinderTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ServicesModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.BodyModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.HeaderModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FloatingPointTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.EnumTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DateTimeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.SimpleTypeModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.TryParseModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CancellationTokenModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ByteArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormFileModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.FormCollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.KeyValuePairModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.DictionaryModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ArrayModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.CollectionModelBinderProvider","Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexObjectModelBinderProvider"]
2025-10-26 14:04:46.382 +03:00 [DBG] Hosting starting
2025-10-26 14:04:46.803 +03:00 [DBG] Starting bus instances: IBus
2025-10-26 14:04:46.811 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-10-26 14:04:46.840 +03:00 [DBG] Middleware loaded
2025-10-26 14:04:46.845 +03:00 [DBG] Middleware loaded. Script /_framework/aspnetcore-browser-refresh.js (16519 B).
2025-10-26 14:04:46.850 +03:00 [DBG] Middleware loaded. Script /_framework/blazor-hotreload.js (799 B).
2025-10-26 14:04:46.863 +03:00 [DBG] Connect: guest@localhost:5672/
2025-10-26 14:04:46.979 +03:00 [DBG] Middleware loaded: DOTNET_MODIFIABLE_ASSEMBLIES=debug, __ASPNETCORE_BROWSER_TOOLS=true
2025-10-26 14:04:47.007 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 56653)
2025-10-26 14:04:47.072 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemAPI_bus_8tcyyyyh3bcsbggybdxbe953r9?temporary=true"
2025-10-26 14:04:47.076 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-10-26 14:04:47.306 +03:00 [INF] Now listening on: https://localhost:7257
2025-10-26 14:04:47.314 +03:00 [INF] Now listening on: http://localhost:5009
2025-10-26 14:04:47.320 +03:00 [DBG] Loaded hosting startup assembly BillingSystem.API
2025-10-26 14:04:47.326 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.ApiEndpointDiscovery
2025-10-26 14:04:47.330 +03:00 [DBG] Loaded hosting startup assembly Microsoft.AspNetCore.Watch.BrowserRefresh
2025-10-26 14:04:47.331 +03:00 [DBG] Loaded hosting startup assembly Microsoft.WebTools.BrowserLink.Net
2025-10-26 14:04:47.335 +03:00 [DBG] Connection id "0HNGKFTSVTOPH" accepted.
2025-10-26 14:04:47.337 +03:00 [DBG] Connection id "0HNGKFTSVTOPH" started.
2025-10-26 14:04:47.368 +03:00 [DBG] Connection id "0HNGKFTSVTOPH" received FIN.
2025-10-26 14:04:47.388 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 14:04:47.417 +03:00 [DBG] Connection id "0HNGKFTSVTOPH" stopped.
2025-10-26 14:04:47.429 +03:00 [DBG] Connection id "0HNGKFTSVTOPH" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 14:04:47.481 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-10-26 14:04:47.483 +03:00 [INF] Hosting environment: Development
2025-10-26 14:04:47.487 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.API
2025-10-26 14:04:47.489 +03:00 [DBG] Hosting started
2025-10-26 14:04:47.870 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" accepted.
2025-10-26 14:04:47.875 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" started.
2025-10-26 14:04:47.935 +03:00 [DBG] Connection 0HNGKFTSVTOPI established using the following protocol: "Tls13"
2025-10-26 14:04:48.016 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/index.html - null null
2025-10-26 14:04:48.074 +03:00 [DBG] Wildcard detected, all requests with hosts will be allowed.
2025-10-26 14:04:48.105 +03:00 [DBG] No candidates found for the request path '/swagger/index.html'
2025-10-26 14:04:48.110 +03:00 [DBG] Request did not match any endpoints
2025-10-26 14:04:48.206 +03:00 [DBG] Response markup is scheduled to include Browser Link script injection.
2025-10-26 14:04:48.210 +03:00 [DBG] Response markup is scheduled to include browser refresh script injection.
2025-10-26 14:04:48.234 +03:00 [INF] HTTP GET /swagger/index.html responded 200 in 111.3839 ms
2025-10-26 14:04:48.241 +03:00 [DBG] Response markup was updated to include Browser Link script injection.
2025-10-26 14:04:48.244 +03:00 [DBG] Response markup was updated to include browser refresh script injection.
2025-10-26 14:04:48.250 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/index.html - 200 null text/html;charset=utf-8 245.3572ms
2025-10-26 14:04:48.273 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - null null
2025-10-26 14:04:48.287 +03:00 [DBG] Script injected: /_framework/aspnetcore-browser-refresh.js
2025-10-26 14:04:48.291 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_framework/aspnetcore-browser-refresh.js - 200 16519 application/javascript; charset=utf-8 18.3678ms
2025-10-26 14:04:48.299 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/_vs/browserLink - null null
2025-10-26 14:04:48.359 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/_vs/browserLink - 200 null text/javascript; charset=UTF-8 59.3731ms
2025-10-26 14:04:48.413 +03:00 [INF] Request starting HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - null null
2025-10-26 14:04:48.420 +03:00 [DBG] No candidates found for the request path '/swagger/v1/swagger.json'
2025-10-26 14:04:48.422 +03:00 [DBG] Request did not match any endpoints
2025-10-26 14:04:48.435 +03:00 [INF] HTTP GET /swagger/v1/swagger.json responded 200 in 9.9057 ms
2025-10-26 14:04:48.441 +03:00 [INF] Request finished HTTP/2 GET https://localhost:7257/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 28.5813ms
2025-10-26 14:05:37.485 +03:00 [DBG] Connection id "0HNGKFTSVTOPJ" accepted.
2025-10-26 14:05:37.487 +03:00 [DBG] Connection id "0HNGKFTSVTOPJ" received FIN.
2025-10-26 14:05:37.500 +03:00 [DBG] Connection id "0HNGKFTSVTOPJ" started.
2025-10-26 14:05:37.506 +03:00 [DBG] Connection id "0HNGKFTSVTOPK" accepted.
2025-10-26 14:05:37.512 +03:00 [DBG] Failed to authenticate HTTPS connection.
System.IO.IOException: Received an unexpected EOF or 0 bytes from the transport stream.
   at System.Net.Security.SslStream.ReceiveHandshakeFrameAsync[TIOAdapter](CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ForceAuthenticationAsync[TIOAdapter](Boolean receiveFirst, Byte[] reAuthenticationData, CancellationToken cancellationToken)
   at System.Net.Security.SslStream.ProcessAuthenticationWithTelemetryAsync(Boolean isAsync, CancellationToken cancellationToken)
   at Microsoft.AspNetCore.Server.Kestrel.Https.Internal.HttpsConnectionMiddleware.OnConnectionAsync(ConnectionContext context)
2025-10-26 14:05:37.513 +03:00 [DBG] Connection id "0HNGKFTSVTOPK" started.
2025-10-26 14:05:37.519 +03:00 [DBG] Connection id "0HNGKFTSVTOPJ" stopped.
2025-10-26 14:05:37.522 +03:00 [DBG] Connection id "0HNGKFTSVTOPJ" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 14:05:37.527 +03:00 [DBG] Connection 0HNGKFTSVTOPK established using the following protocol: "Tls13"
2025-10-26 14:05:37.535 +03:00 [INF] Request starting HTTP/1.1 POST https://localhost:7257/api/Invoices - application/json 262
2025-10-26 14:05:37.547 +03:00 [DBG] 1 candidate(s) found for the request path '/api/Invoices'
2025-10-26 14:05:37.559 +03:00 [DBG] Endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)' with route pattern 'api/Invoices' is valid for the request path '/api/Invoices'
2025-10-26 14:05:37.567 +03:00 [DBG] Request matched endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 14:05:37.576 +03:00 [DBG] Static files was skipped as the request already matched an endpoint.
2025-10-26 14:05:37.776 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-10-26 14:05:43.203 +03:00 [INF] Executing endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 14:05:43.256 +03:00 [INF] Route matched with {action = "Post", controller = "Invoices"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Post(BillingSystem.Application.Requests.CreateInvoiceRequest) on controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API).
2025-10-26 14:05:43.263 +03:00 [DBG] Execution plan of authorization filters (in the following order): ["None"]
2025-10-26 14:05:43.266 +03:00 [DBG] Execution plan of resource filters (in the following order): ["None"]
2025-10-26 14:05:43.269 +03:00 [DBG] Execution plan of action filters (in the following order): ["Microsoft.AspNetCore.Mvc.ModelBinding.UnsupportedContentTypeFilter (Order: -3000)","Microsoft.AspNetCore.Mvc.Infrastructure.ModelStateInvalidFilter (Order: -2000)","BillingSystem.API.ActionFilters.AuditBillingRequestsFilter","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 14:05:43.274 +03:00 [DBG] Execution plan of exception filters (in the following order): ["None"]
2025-10-26 14:05:43.279 +03:00 [DBG] Execution plan of result filters (in the following order): ["Microsoft.AspNetCore.Mvc.Infrastructure.ClientErrorResultFilter (Order: -2000)","Microsoft.AspNetCore.Mvc.ProducesAttribute (Order: 0)","BillingSystem.API.ActionFilters.IdempotencyFilter (Order: 0)"]
2025-10-26 14:05:43.285 +03:00 [DBG] Executing controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 14:05:43.292 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software MediatR. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 14:05:43.334 +03:00 [DBG] Executed controller factory for controller BillingSystem.API.Controllers.InvoicesController (BillingSystem.API)
2025-10-26 14:05:43.358 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 14:05:43.365 +03:00 [DBG] Attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' using the name '' in request data ...
2025-10-26 14:05:43.372 +03:00 [DBG] Selected input formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonInputFormatter' for content type 'application/json'.
2025-10-26 14:05:43.397 +03:00 [DBG] Connection id "0HNGKFTSVTOPK", Request id "0HNGKFTSVTOPK:00000001": started reading request body.
2025-10-26 14:05:43.404 +03:00 [DBG] Connection id "0HNGKFTSVTOPK", Request id "0HNGKFTSVTOPK:00000001": done reading request body.
2025-10-26 14:05:43.429 +03:00 [DBG] JSON input formatter succeeded, deserializing to type 'BillingSystem.Application.Requests.CreateInvoiceRequest'
2025-10-26 14:05:43.433 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 14:05:43.436 +03:00 [DBG] Done attempting to bind parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 14:05:43.439 +03:00 [DBG] Attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest' ...
2025-10-26 14:05:43.456 +03:00 [DBG] Done attempting to validate the bound parameter 'invoiceRequest' of type 'BillingSystem.Application.Requests.CreateInvoiceRequest'.
2025-10-26 14:05:44.240 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-10-26 14:05:44.336 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .AsNoTracking()
    .Any(inv => inv.ExternalId.ToString() == __idempotentKey_0)'
2025-10-26 14:05:44.627 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<bool>(
    asyncEnumerable: SingleQueryingEnumerable.Create<bool>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0)) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT EXISTS (
                SELECT 1
                FROM Invoices AS i
                WHERE COALESCE(CONVERT(varchar(36), i.ExternalId), '') == @__idempotentKey_0), 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            bool? value1;
            value1 = dataReader.IsDBNull(0) ? default(bool?) : (bool?)dataReader.GetBoolean(0);
            return (bool)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 14:05:44.692 +03:00 [DBG] Creating DbConnection.
2025-10-26 14:05:44.720 +03:00 [DBG] Created DbConnection. (25ms).
2025-10-26 14:05:44.732 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:05:45.106 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:05:45.117 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 14:05:45.136 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (13ms).
2025-10-26 14:05:45.151 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (34ms).
2025-10-26 14:05:45.173 +03:00 [DBG] Executing DbCommand [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 14:05:45.269 +03:00 [INF] Executed DbCommand (101ms) [Parameters=[@__idempotentKey_0='?' (Size = 36) (DbType = AnsiString)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Invoices] AS [i]
        WHERE CONVERT(varchar(36), [i].[ExternalId]) = @__idempotentKey_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-10-26 14:05:45.306 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-10-26 14:05:45.325 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 39ms reading results.
2025-10-26 14:05:45.338 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:05:45.347 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (10ms).
2025-10-26 14:05:45.509 +03:00 [WRN] You do not have a valid license key for the Lucky Penny software AutoMapper. This is allowed for development and testing scenarios. If you are running in production you are required to have a licensed version. Please visit https://luckypennysoftware.com to obtain a valid license.
2025-10-26 14:05:52.836 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:05:52.843 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:05:52.850 +03:00 [DBG] Beginning transaction with isolation level 'Unspecified'.
2025-10-26 14:05:52.867 +03:00 [DBG] Began transaction with isolation level 'ReadCommitted'.
2025-10-26 14:05:54.081 +03:00 [DBG] Compiling query expression: 
'SqlQuery<long>(SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value, __p_0)
    .First()'
2025-10-26 14:05:54.091 +03:00 [WRN] The query uses the 'First'/'FirstOrDefault' operator without 'OrderBy' and filter operators. This may lead to unpredictable results.
2025-10-26 14:05:54.098 +03:00 [DBG] Generated query execution expression: 
'queryContext => ShapedQueryCompilingExpressionVisitor.SingleAsync<long>(
    asyncEnumerable: SingleQueryingEnumerable.Create<long>(
        relationalQueryContext: (RelationalQueryContext)queryContext, 
        relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value) | Resolver: c => new RelationalCommandCache(
            c.Dependencies.MemoryCache, 
            c.RelationalDependencies.QuerySqlGeneratorFactory, 
            c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
            Projection Mapping:
                EmptyProjectionMember -> 0
            SELECT TOP(1) s.Value
            FROM SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value, 
            False, 
            new HashSet<string>(
                new string[]{ }, 
                StringComparer.Ordinal
            )
        )].GetRelationalCommandTemplate(parameters), 
        readerColumns: null, 
        shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
        {
            long? value1;
            value1 = dataReader.IsDBNull(0) ? default(long?) : (long?)dataReader.GetInt64(0);
            return (long)value1;
        }, 
        contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
        standAloneStateManager: False, 
        detailedErrorsEnabled: False, 
        threadSafetyChecksEnabled: True), 
    cancellationToken: queryContext.CancellationToken)'
2025-10-26 14:05:54.111 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-10-26 14:05:54.115 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (3ms).
2025-10-26 14:05:54.121 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (9ms).
2025-10-26 14:05:54.125 +03:00 [DBG] Executing DbCommand [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value
) AS [s]
2025-10-26 14:05:54.163 +03:00 [ERR] Failed executing DbCommand (37ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [s].[Value]
FROM (
    SELECT CAST(NEXT VALUE FOR dbo.InvoiceNumberSequence AS BIGINT) AS Value
) AS [s]
2025-10-26 14:05:54.179 +03:00 [ERR] An exception occurred while iterating over the results of a query for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:d8f584cb-582c-4d24-81fe-f6725ce43a91
Error Number:11719,State:1,Class:15
Microsoft.Data.SqlClient.SqlException (0x80131904): NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
ClientConnectionId:d8f584cb-582c-4d24-81fe-f6725ce43a91
Error Number:11719,State:1,Class:15
2025-10-26 14:06:27.925 +03:00 [ERR] exception occured NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements. , stackTrace    at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Insert(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 60
2025-10-26 14:06:27.940 +03:00 [DBG] Rolling back transaction.
2025-10-26 14:06:27.950 +03:00 [DBG] Rolled back transaction.
2025-10-26 14:06:27.954 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:06:27.959 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (5ms).
2025-10-26 14:06:27.988 +03:00 [DBG] Disposing transaction.
2025-10-26 14:06:28.063 +03:00 [ERR] exception occured NEXT VALUE FOR function is not allowed in check constraints, default objects, computed columns, views, user-defined functions, user-defined aggregates, user-defined table types, sub-queries, common table expressions, derived tables or return statements. , stackTrace    at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.InitializeReaderAsync(AsyncEnumerator enumerator, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.ShapedQueryCompilingExpressionVisitor.SingleAsync[TSource](IAsyncEnumerable`1 asyncEnumerable, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Insert(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 60
   at BillingSystem.Application.Commands.CreateInvoiceCommandRequestHandler.Handle(CreateInvoiceRequest request, CancellationToken cancellationToken) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Application\Commands\CreateInvoiceCommandRequestHandler.cs:line 39
   at BillingSystem.API.Controllers.InvoicesController.Post(CreateInvoiceRequest invoiceRequest) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.API\Controllers\InvoicesController.cs:line 45
2025-10-26 14:06:28.118 +03:00 [DBG] List of registered output formatters, in the following order: ["Microsoft.AspNetCore.Mvc.Formatters.HttpNoContentOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.StringOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.StreamOutputFormatter","Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonOutputFormatter"]
2025-10-26 14:06:28.128 +03:00 [DBG] No information found on request to perform content negotiation.
2025-10-26 14:06:28.130 +03:00 [DBG] Attempting to select the first output formatter in the output formatters list which supports a content type from the explicitly specified content types '["application/json","application/problem+json","application/problem+xml"]'.
2025-10-26 14:06:28.136 +03:00 [DBG] Selected output formatter 'Microsoft.AspNetCore.Mvc.Formatters.SystemTextJsonOutputFormatter' and content type 'application/json' to write the response.
2025-10-26 14:06:28.140 +03:00 [INF] Executing ObjectResult, writing value of type 'Microsoft.AspNetCore.Mvc.ProblemDetails'.
2025-10-26 14:06:28.178 +03:00 [INF] Executed action BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API) in 44890.6953ms
2025-10-26 14:06:28.191 +03:00 [INF] Executed endpoint 'BillingSystem.API.Controllers.InvoicesController.Post (BillingSystem.API)'
2025-10-26 14:06:28.195 +03:00 [ERR] HTTP POST /api/Invoices responded 500 in 50621.9819 ms
2025-10-26 14:06:28.204 +03:00 [DBG] Connection id "0HNGKFTSVTOPK" completed keep alive response.
2025-10-26 14:06:28.211 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-10-26 14:06:28.219 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-10-26 14:06:28.226 +03:00 [DBG] Disposed connection to database '' on server '' (7ms).
2025-10-26 14:06:28.229 +03:00 [INF] Request finished HTTP/1.1 POST https://localhost:7257/api/Invoices - 500 null application/json; charset=utf-8 50694.363ms
2025-10-26 14:12:20.890 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" received FIN.
2025-10-26 14:12:20.916 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" is closed. The last processed stream ID was 7.
2025-10-26 14:12:20.919 +03:00 [DBG] The connection queue processing loop for 0HNGKFTSVTOPI completed.
2025-10-26 14:12:20.979 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" sending FIN because: "The Socket transport's send loop completed gracefully."
2025-10-26 14:12:21.003 +03:00 [DBG] Connection id "0HNGKFTSVTOPI" stopped.
