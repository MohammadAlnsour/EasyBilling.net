2025-11-19 10:06:25.857 +03:00 [DBG] Hosting starting
2025-11-19 10:06:26.302 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 10:06:26.310 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 10:06:26.357 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 10:06:26.361 +03:00 [INF] Hosting environment: Development
2025-11-19 10:06:26.366 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 10:06:26.367 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 10:06:26.372 +03:00 [DBG] Hosting started
2025-11-19 10:06:26.406 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 56971)
2025-11-19 10:06:26.416 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 10:06:26.483 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_gt8yyyyh3bcsytchbdxnqqt8fw?temporary=true"
2025-11-19 10:06:26.486 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 10:07:30.481 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 10:07:35.962 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 10:07:36.161 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 10:07:36.176 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 10:07:36.186 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 10:07:36.519 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 10:07:36.625 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 10:07:36.942 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 10:07:36.996 +03:00 [DBG] Creating DbConnection.
2025-11-19 10:07:37.029 +03:00 [DBG] Created DbConnection. (30ms).
2025-11-19 10:07:37.037 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:07:37.413 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:07:37.423 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 10:07:37.439 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (10ms).
2025-11-19 10:07:37.456 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (34ms).
2025-11-19 10:07:37.472 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 10:07:37.530 +03:00 [INF] Executed DbCommand (60ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 10:07:37.543 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 10:07:37.555 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 12ms reading results.
2025-11-19 10:07:37.563 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:07:37.573 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (10ms).
2025-11-19 10:07:37.622 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 10:07:37.627 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:07:37.632 +03:00 [DBG] Disposed connection to database '' on server '' (5ms).
2025-11-19 10:08:11.472 +03:00 [INF] Processed message: invoice Id: 0
2025-11-19 10:10:53.891 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 10:10:53.907 +03:00 [DBG] Creating DbConnection.
2025-11-19 10:10:53.912 +03:00 [DBG] Created DbConnection. (4ms).
2025-11-19 10:10:53.916 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:10:53.922 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:10:53.926 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 10:10:53.929 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (2ms).
2025-11-19 10:10:53.934 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (8ms).
2025-11-19 10:10:53.940 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 10:10:53.954 +03:00 [INF] Executed DbCommand (14ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 10:10:53.961 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 10:10:53.964 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 3ms reading results.
2025-11-19 10:10:53.968 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:10:53.973 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (4ms).
2025-11-19 10:10:53.980 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 10:10:53.984 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 10:10:53.990 +03:00 [DBG] Disposed connection to database '' on server '' (5ms).
2025-11-19 10:10:53.995 +03:00 [INF] Processed message: invoice Id: 0
2025-11-19 11:01:56.488 +03:00 [DBG] Hosting starting
2025-11-19 11:01:56.873 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 11:01:56.882 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 11:01:56.923 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 11:01:56.942 +03:00 [INF] Hosting environment: Development
2025-11-19 11:01:56.956 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 11:01:56.958 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 11:01:56.958 +03:00 [DBG] Hosting started
2025-11-19 11:01:56.990 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 52432)
2025-11-19 11:01:57.008 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 11:01:57.074 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_qt5yyyyh3bcsbgqzbdxnqoxe8j?temporary=true"
2025-11-19 11:01:57.077 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 11:23:52.111 +03:00 [DBG] Hosting starting
2025-11-19 11:23:52.552 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 11:23:52.559 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 11:23:52.592 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 11:23:52.604 +03:00 [INF] Hosting environment: Development
2025-11-19 11:23:52.608 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 11:23:52.622 +03:00 [DBG] Hosting started
2025-11-19 11:23:52.622 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 11:23:52.639 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 61879)
2025-11-19 11:23:52.655 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 11:23:52.693 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_ybjoyyyh3bcsy4z9bdxnqt83yz?temporary=true"
2025-11-19 11:23:52.696 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:04:32.086 +03:00 [DBG] Hosting starting
2025-11-19 12:04:32.735 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:04:32.746 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:04:32.818 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:04:32.828 +03:00 [INF] Hosting environment: Development
2025-11-19 12:04:32.861 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:04:32.866 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:04:32.866 +03:00 [DBG] Hosting started
2025-11-19 12:04:32.907 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 52608)
2025-11-19 12:04:32.915 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:04:33.016 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_9nzoyyyh3bcsy3tnbdxnq1i8rb?temporary=true"
2025-11-19 12:04:33.021 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:06:03.222 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 12:06:03.594 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:06:03.788 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:06:03.809 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:06:03.827 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:06:04.275 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:06:04.382 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 12:06:04.701 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 12:06:04.747 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:06:04.774 +03:00 [DBG] Created DbConnection. (23ms).
2025-11-19 12:06:04.781 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.135 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.146 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:06:05.163 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (10ms).
2025-11-19 12:06:05.188 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (42ms).
2025-11-19 12:06:05.208 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:06:05.279 +03:00 [INF] Executed DbCommand (77ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:06:05.350 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:06:05.465 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.485 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 186ms reading results.
2025-11-19 12:06:05.494 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.505 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (10ms).
2025-11-19 12:06:05.629 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:06:05.655 +03:00 [DBG] The foreign key property 'Invoice.CustomerId' was detected as changed. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see property values.
2025-11-19 12:06:05.673 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:06:05.682 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:06:05.689 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:06:05.763 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.776 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.783 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:06:05.788 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (4ms).
2025-11-19 12:06:05.791 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (8ms).
2025-11-19 12:06:05.798 +03:00 [DBG] Executing DbCommand [Parameters=[@p9='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [ProviderResponse] = @p8
OUTPUT 1
WHERE [Id] = @p9;
2025-11-19 12:06:05.870 +03:00 [INF] Executed DbCommand (72ms) [Parameters=[@p9='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [ProviderResponse] = @p8
OUTPUT 1
WHERE [Id] = @p9;
2025-11-19 12:06:05.901 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.906 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 22ms reading results.
2025-11-19 12:06:05.916 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:05.920 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (4ms).
2025-11-19 12:06:05.952 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:7352b707-b006-477d-acbe-f734d0a47a81
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:7352b707-b006-477d-acbe-f734d0a47a81
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-11-19 12:06:06.096 +03:00 [ERR] exception occured An error occurred while saving the entity changes. See the inner exception for details. , stackTrace    at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Update(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 201
2025-11-19 12:06:06.102 +03:00 [ERR] exception inner exception Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails. , stackTrace    at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
2025-11-19 12:06:06.107 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 12:06:06.116 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:06:06.121 +03:00 [DBG] Disposed connection to database '' on server '' (4ms).
2025-11-19 12:06:08.861 +03:00 [INF] Processed message: invoice Id: 10012
2025-11-19 12:36:08.172 +03:00 [DBG] Hosting starting
2025-11-19 12:36:08.813 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:36:08.825 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:36:08.881 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:36:08.906 +03:00 [INF] Hosting environment: Development
2025-11-19 12:36:08.922 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:36:08.926 +03:00 [DBG] Hosting started
2025-11-19 12:36:08.928 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:36:08.961 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 50165)
2025-11-19 12:36:08.967 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:36:09.002 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_dyooyyyh3bcsy79gbdxnquatf8?temporary=true"
2025-11-19 12:36:09.006 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:38:48.260 +03:00 [DBG] Hosting starting
2025-11-19 12:38:48.747 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:38:48.755 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:38:48.805 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:38:48.807 +03:00 [INF] Hosting environment: Development
2025-11-19 12:38:48.818 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:38:48.818 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:38:48.824 +03:00 [DBG] Hosting started
2025-11-19 12:38:48.835 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 59596)
2025-11-19 12:38:48.850 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:38:48.888 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_eyjyyyyh3bcsyficbdxnqu5tye?temporary=true"
2025-11-19 12:38:48.891 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:41:48.139 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 12:42:00.958 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:42:01.160 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:42:01.180 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:42:01.195 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:42:01.655 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:42:01.740 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 12:42:02.074 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 12:42:02.127 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:42:02.164 +03:00 [DBG] Created DbConnection. (34ms).
2025-11-19 12:42:02.175 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:02.555 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:02.564 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:42:02.580 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (10ms).
2025-11-19 12:42:02.597 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (33ms).
2025-11-19 12:42:02.621 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:42:02.717 +03:00 [INF] Executed DbCommand (102ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:42:02.799 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:42:02.871 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:42:02.888 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 157ms reading results.
2025-11-19 12:42:02.897 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:02.905 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (8ms).
2025-11-19 12:42:02.984 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:42:03.000 +03:00 [DBG] The foreign key property 'Invoice.CustomerId' was detected as changed. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see property values.
2025-11-19 12:42:03.016 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:42:03.026 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:42:03.035 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:42:03.103 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:03.118 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:03.129 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:42:03.135 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (5ms).
2025-11-19 12:42:03.143 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (14ms).
2025-11-19 12:42:03.149 +03:00 [DBG] Executing DbCommand [Parameters=[@p11='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 100), @p9='?' (Size = 100), @p10='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [PaymentProvider] = @p8, [PaymentReference] = @p9, [ProviderResponse] = @p10
OUTPUT 1
WHERE [Id] = @p11;
2025-11-19 12:42:03.198 +03:00 [INF] Executed DbCommand (50ms) [Parameters=[@p11='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 100), @p9='?' (Size = 100), @p10='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [PaymentProvider] = @p8, [PaymentReference] = @p9, [ProviderResponse] = @p10
OUTPUT 1
WHERE [Id] = @p11;
2025-11-19 12:42:03.222 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:42:03.231 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 26ms reading results.
2025-11-19 12:42:03.243 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:03.251 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (8ms).
2025-11-19 12:42:03.283 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:bbdb1c21-4c7d-406d-aeb9-4214c08087cf
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:bbdb1c21-4c7d-406d-aeb9-4214c08087cf
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-11-19 12:42:03.382 +03:00 [ERR] exception occured An error occurred while saving the entity changes. See the inner exception for details. , stackTrace    at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Update(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 201
2025-11-19 12:42:03.392 +03:00 [ERR] exception inner exception Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails. , stackTrace    at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
2025-11-19 12:42:03.428 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 12:42:03.438 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:42:03.446 +03:00 [DBG] Disposed connection to database '' on server '' (8ms).
2025-11-19 12:42:24.322 +03:00 [ERR] exception occured Cannot access a disposed context instance. A common cause of this error is disposing a context instance that was resolved from dependency injection and then later trying to use the same context instance elsewhere in your application. This may occur if you are calling 'Dispose' on the context instance, or wrapping it in a using statement. If you are using dependency injection, you should let the dependency injection container take care of disposing context instances.
Object name: 'BillingServiceDBContext'. , stackTrace    at Microsoft.EntityFrameworkCore.DbContext.CheckDisposed()
   at Microsoft.EntityFrameworkCore.DbContext.get_ContextServices()
   at Microsoft.EntityFrameworkCore.DbContext.get_InternalServiceProvider()
   at Microsoft.EntityFrameworkCore.DbContext.get_ChangeTracker()
   at Microsoft.EntityFrameworkCore.Query.CompiledQueryCacheKeyGenerator.GenerateCacheKeyCore(Expression query, Boolean async)
   at Microsoft.EntityFrameworkCore.Query.RelationalCompiledQueryCacheKeyGenerator.GenerateCacheKeyCore(Expression query, Boolean async)
   at Microsoft.EntityFrameworkCore.SqlServer.Query.Internal.SqlServerCompiledQueryCacheKeyGenerator.GenerateCacheKey(Expression query, Boolean async)
   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.ExecuteCore[TResult](Expression query, Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Query.Internal.QueryCompiler.Execute[TResult](Expression query)
   at Microsoft.EntityFrameworkCore.Query.Internal.EntityQueryProvider.Execute[TResult](Expression expression)
   at BillingSystem.Infrastructure.Persistence.EF.InvoiceRepository.Update(Invoice entity) in C:\Repositories\Gac-BillingSystem\src\BillingSystem.Infrastructure\Persistence\EF\InvoiceRepository.cs:line 186
2025-11-19 12:42:24.330 +03:00 [INF] Processed message: invoice Id: 10013
2025-11-19 12:44:13.725 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:44:13.736 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:44:13.738 +03:00 [DBG] Created DbConnection. (2ms).
2025-11-19 12:44:13.740 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:44:13.743 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:44:13.747 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:44:13.749 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (2ms).
2025-11-19 12:44:13.752 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (4ms).
2025-11-19 12:44:13.756 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:44:13.763 +03:00 [INF] Executed DbCommand (7ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:44:13.768 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:44:13.772 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:44:13.775 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 8ms reading results.
2025-11-19 12:44:13.779 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:44:13.782 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (3ms).
2025-11-19 12:44:58.235 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:44:58.242 +03:00 [DBG] The foreign key property 'Invoice.CustomerId' was detected as changed. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see property values.
2025-11-19 12:45:07.817 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:45:07.824 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:45:07.828 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:45:07.832 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:45:07.839 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:45:07.845 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:45:07.849 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (4ms).
2025-11-19 12:45:07.852 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (6ms).
2025-11-19 12:45:07.855 +03:00 [DBG] Executing DbCommand [Parameters=[@p11='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 100), @p9='?' (Size = 100), @p10='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [PaymentProvider] = @p8, [PaymentReference] = @p9, [ProviderResponse] = @p10
OUTPUT 1
WHERE [Id] = @p11;
2025-11-19 12:45:07.868 +03:00 [INF] Executed DbCommand (11ms) [Parameters=[@p11='?' (DbType = Int64), @p0='?' (Size = 50), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int64), @p3='?' (DbType = DateTime), @p4='?' (DbType = Int32), @p5='?' (DbType = Boolean), @p6='?' (DbType = DateTime), @p7='?' (DbType = DateTime), @p8='?' (Size = 100), @p9='?' (Size = 100), @p10='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedBy] = @p0, [CreatedDate] = @p1, [CustomerID] = @p2, [DueAt] = @p3, [InvoiceStatus] = @p4, [IsSubInvoice] = @p5, [IssuedAt] = @p6, [LastUpdatedDate] = @p7, [PaymentProvider] = @p8, [PaymentReference] = @p9, [ProviderResponse] = @p10
OUTPUT 1
WHERE [Id] = @p11;
2025-11-19 12:45:07.884 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:45:07.888 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 5ms reading results.
2025-11-19 12:45:07.892 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:45:07.896 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (3ms).
2025-11-19 12:45:07.902 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:bbdb1c21-4c7d-406d-aeb9-4214c08087cf
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert the value NULL into column 'CreatedBy', table 'GAC-BillingService.dbo.Invoices'; column does not allow nulls. UPDATE fails.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:bbdb1c21-4c7d-406d-aeb9-4214c08087cf
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-11-19 12:46:02.999 +03:00 [DBG] Hosting starting
2025-11-19 12:46:03.640 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:46:03.648 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:46:03.686 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:46:03.701 +03:00 [INF] Hosting environment: Development
2025-11-19 12:46:03.705 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:46:03.715 +03:00 [DBG] Hosting started
2025-11-19 12:46:03.720 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:46:03.752 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 50174)
2025-11-19 12:46:03.756 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:47:23.355 +03:00 [DBG] Hosting starting
2025-11-19 12:47:23.693 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:47:23.699 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:47:23.732 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:47:23.734 +03:00 [INF] Hosting environment: Development
2025-11-19 12:47:23.736 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:47:23.739 +03:00 [DBG] Hosting started
2025-11-19 12:47:23.739 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:47:23.761 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 49737)
2025-11-19 12:47:23.773 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:47:30.320 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_4bmoyyyh3bcsbs8nbdxnqwfd89?temporary=true"
2025-11-19 12:47:30.333 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:47:34.473 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 12:47:44.649 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:47:44.948 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:47:44.962 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:47:44.973 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:47:45.432 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:47:45.527 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 12:47:45.948 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 12:47:45.993 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:47:46.016 +03:00 [DBG] Created DbConnection. (20ms).
2025-11-19 12:47:46.021 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:46.317 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:46.323 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:47:46.333 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (7ms).
2025-11-19 12:47:46.345 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (22ms).
2025-11-19 12:47:46.358 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:47:46.411 +03:00 [INF] Executed DbCommand (54ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:47:46.470 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:47:46.548 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:47:46.559 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 137ms reading results.
2025-11-19 12:47:46.564 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:46.572 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (7ms).
2025-11-19 12:47:54.647 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:47:54.662 +03:00 [DBG] The foreign key property 'Invoice.CustomerId' was detected as changed. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see property values.
2025-11-19 12:47:55.186 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:47:55.198 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:47:55.208 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:47:55.307 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:55.316 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:55.332 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:47:55.336 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (9ms).
2025-11-19 12:47:55.339 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (13ms).
2025-11-19 12:47:55.344 +03:00 [DBG] Executing DbCommand [Parameters=[@p10='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = Int64), @p2='?' (DbType = DateTime), @p3='?' (DbType = Int32), @p4='?' (DbType = Boolean), @p5='?' (DbType = DateTime), @p6='?' (DbType = DateTime), @p7='?' (Size = 100), @p8='?' (Size = 100), @p9='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [CustomerID] = @p1, [DueAt] = @p2, [InvoiceStatus] = @p3, [IsSubInvoice] = @p4, [IssuedAt] = @p5, [LastUpdatedDate] = @p6, [PaymentProvider] = @p7, [PaymentReference] = @p8, [ProviderResponse] = @p9
OUTPUT 1
WHERE [Id] = @p10;
2025-11-19 12:47:55.395 +03:00 [INF] Executed DbCommand (51ms) [Parameters=[@p10='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = Int64), @p2='?' (DbType = DateTime), @p3='?' (DbType = Int32), @p4='?' (DbType = Boolean), @p5='?' (DbType = DateTime), @p6='?' (DbType = DateTime), @p7='?' (Size = 100), @p8='?' (Size = 100), @p9='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [CustomerID] = @p1, [DueAt] = @p2, [InvoiceStatus] = @p3, [IsSubInvoice] = @p4, [IssuedAt] = @p5, [LastUpdatedDate] = @p6, [PaymentProvider] = @p7, [PaymentReference] = @p8, [ProviderResponse] = @p9
OUTPUT 1
WHERE [Id] = @p10;
2025-11-19 12:47:55.418 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:47:55.422 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 21ms reading results.
2025-11-19 12:47:55.430 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:47:55.433 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (3ms).
2025-11-19 12:47:55.459 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'BillingSystem.Infrastructure.EF.BillingServiceDBContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The UPDATE statement conflicted with the FOREIGN KEY constraint "FK_Invoices_Customers". The conflict occurred in database "GAC-BillingService", table "dbo.Customers", column 'Id'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:38437c1c-811d-4842-85ed-d71401de2d28
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The UPDATE statement conflicted with the FOREIGN KEY constraint "FK_Invoices_Customers". The conflict occurred in database "GAC-BillingService", table "dbo.Customers", column 'Id'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetWithRowsAffectedOnlyAsync(Int32 commandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:38437c1c-811d-4842-85ed-d71401de2d28
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-11-19 12:48:49.504 +03:00 [DBG] Hosting starting
2025-11-19 12:48:50.369 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:48:50.381 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:48:50.453 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:48:50.459 +03:00 [INF] Hosting environment: Development
2025-11-19 12:48:50.476 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:48:50.481 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:48:50.482 +03:00 [DBG] Hosting started
2025-11-19 12:48:50.539 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 60945)
2025-11-19 12:48:50.554 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:48:54.286 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_sy5yyyyh3bcsb6tsbdxnqwgzrk?temporary=true"
2025-11-19 12:48:54.289 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:48:57.890 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 12:49:01.521 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:49:01.781 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:49:01.795 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:49:01.805 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:49:02.162 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:49:02.222 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 12:49:02.416 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 12:49:02.456 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:49:02.476 +03:00 [DBG] Created DbConnection. (18ms).
2025-11-19 12:49:02.482 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:02.735 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:02.742 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:49:02.750 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (5ms).
2025-11-19 12:49:02.759 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (18ms).
2025-11-19 12:49:02.773 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:49:02.823 +03:00 [INF] Executed DbCommand (51ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:49:02.878 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:49:02.946 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:49:02.960 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 125ms reading results.
2025-11-19 12:49:02.967 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:02.976 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (9ms).
2025-11-19 12:49:08.393 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:49:08.995 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:49:09.007 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:49:09.018 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:49:09.110 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:09.118 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:09.131 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:49:09.134 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (3ms).
2025-11-19 12:49:09.142 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (11ms).
2025-11-19 12:49:09.148 +03:00 [DBG] Executing DbCommand [Parameters=[@p9='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime), @p5='?' (DbType = DateTime), @p6='?' (Size = 100), @p7='?' (Size = 100), @p8='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [DueAt] = @p1, [InvoiceStatus] = @p2, [IsSubInvoice] = @p3, [IssuedAt] = @p4, [LastUpdatedDate] = @p5, [PaymentProvider] = @p6, [PaymentReference] = @p7, [ProviderResponse] = @p8
OUTPUT 1
WHERE [Id] = @p9;
2025-11-19 12:49:09.215 +03:00 [INF] Executed DbCommand (67ms) [Parameters=[@p9='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime), @p5='?' (DbType = DateTime), @p6='?' (Size = 100), @p7='?' (Size = 100), @p8='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [DueAt] = @p1, [InvoiceStatus] = @p2, [IsSubInvoice] = @p3, [IssuedAt] = @p4, [LastUpdatedDate] = @p5, [PaymentProvider] = @p6, [PaymentReference] = @p7, [ProviderResponse] = @p8
OUTPUT 1
WHERE [Id] = @p9;
2025-11-19 12:49:09.235 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:49:09.240 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 18ms reading results.
2025-11-19 12:49:09.249 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:09.254 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (5ms).
2025-11-19 12:49:09.267 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Modified"' to '"Unchanged"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:49:09.275 +03:00 [DBG] SaveChanges completed for 'BillingServiceDBContext' with 1 entities written to the database.
2025-11-19 12:49:11.770 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 12:49:11.783 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:49:11.792 +03:00 [DBG] Disposed connection to database '' on server '' (9ms).
2025-11-19 12:49:11.806 +03:00 [INF] Processed message: invoice Id: 10014
2025-11-19 12:57:01.342 +03:00 [DBG] Hosting starting
2025-11-19 12:57:01.918 +03:00 [DBG] Starting bus instances: IBus
2025-11-19 12:57:01.927 +03:00 [DBG] Starting bus: "rabbitmq://localhost/"
2025-11-19 12:57:01.976 +03:00 [INF] Application started. Press Ctrl+C to shut down.
2025-11-19 12:57:01.979 +03:00 [INF] Hosting environment: Development
2025-11-19 12:57:01.993 +03:00 [INF] Content root path: C:\Repositories\Gac-BillingSystem\src\BillingSystem.PaymentOrchestrator
2025-11-19 12:57:02.004 +03:00 [DBG] Hosting started
2025-11-19 12:57:02.007 +03:00 [DBG] Connect: guest@localhost:5672/
2025-11-19 12:57:02.032 +03:00 [DBG] Connected: guest@localhost:5672/ (address: amqp://localhost:5672, local: 55242)
2025-11-19 12:57:02.037 +03:00 [INF] RabbitMQ Consumer started for queue InvoiceCreatedQueue
2025-11-19 12:57:02.090 +03:00 [DBG] Endpoint Ready: "rabbitmq://localhost/ECHGHANNAMLP1_BillingSystemP_bus_qtyoyyyh3bcsywo4bdxnqwxhrw?temporary=true"
2025-11-19 12:57:02.094 +03:00 [INF] Bus started: "rabbitmq://localhost/"
2025-11-19 12:58:00.094 +03:00 [DBG] An 'IServiceProvider' was created for internal use by Entity Framework.
2025-11-19 12:58:04.017 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:58:04.303 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'DiscountedPrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseDiscountedPrimaryInvoice', 'InversePrimaryInvoice', 'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:58:04.323 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:58:04.339 +03:00 [DBG] No relationship from 'Invoice' to 'Invoice' has been configured by convention because there are multiple properties on one entity type - {'InversePrimaryInvoice'} that could be matched with the properties on the other entity type - {'InverseSubstitutionPrimaryInvoice', 'PrimaryInvoice', 'SubstitutionPrimaryInvoice'}. This message can be disregarded if explicit configuration has been specified in 'OnModelCreating'.
2025-11-19 12:58:04.739 +03:00 [DBG] Entity Framework Core 9.0.9 initialized 'BillingServiceDBContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:9.0.9' with options: EngineType=SqlServer 
2025-11-19 12:58:04.859 +03:00 [DBG] Compiling query expression: 
'DbSet<Invoice>()
    .SingleOrDefault(p => p.Id == __entity_Id_0)'
2025-11-19 12:58:05.294 +03:00 [DBG] Generated query execution expression: 
'queryContext => SingleQueryingEnumerable.Create<Invoice>(
    relationalQueryContext: (RelationalQueryContext)queryContext, 
    relationalCommandResolver: parameters => [LIFTABLE Constant: RelationalCommandCache.QueryExpression(
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0) | Resolver: c => new RelationalCommandCache(
        c.Dependencies.MemoryCache, 
        c.RelationalDependencies.QuerySqlGeneratorFactory, 
        c.RelationalDependencies.RelationalParameterBasedSqlProcessorFactory, 
        Projection Mapping:
            EmptyProjectionMember -> Dictionary<IProperty, int> { [Property: Invoice.Id (long) Required PK AfterSave:Throw ValueGenerated.OnAdd, 0], [Property: Invoice.Amount (decimal) Required, 1], [Property: Invoice.CancelationReasons (string) MaxLength(3000), 2], [Property: Invoice.ClientReferenceNumber (string) MaxLength(100), 3], [Property: Invoice.CreatedBy (string) Required MaxLength(50), 4], [Property: Invoice.CreatedDate (DateTime) Required, 5], [Property: Invoice.Currency (string) Required MaxLength(50), 6], [Property: Invoice.CustomerId (long) Required FK Index, 7], [Property: Invoice.DiscountedPrimaryInvoiceId (long?) FK Index, 8], [Property: Invoice.DueAt (DateTime?), 9], [Property: Invoice.ExternalId (Guid) Required Index, 10], [Property: Invoice.InvoiceNumber (string) Required MaxLength(50), 11], [Property: Invoice.InvoiceStatus (int) Required, 12], [Property: Invoice.InvoiceType (int) Required, 13], [Property: Invoice.IsDeleted (bool) Required, 14], [Property: Invoice.IsDiscounted (bool?), 15], [Property: Invoice.IsSubInvoice (bool?), 16], [Property: Invoice.IsSubstitution (bool?), 17], [Property: Invoice.IssuedAt (DateTime) Required, 18], [Property: Invoice.LastUpdatedDate (DateTime?), 19], [Property: Invoice.Metadata (string), 20], [Property: Invoice.PaymentProvider (string) MaxLength(100), 21], [Property: Invoice.PaymentReference (string) MaxLength(100), 22], [Property: Invoice.PrimaryInvoiceId (long?) FK Index, 23], [Property: Invoice.ProviderResponse (string), 24], [Property: Invoice.SubstitutionPrimaryInvoiceId (long?) FK Index, 25], [Property: Invoice.TenantId (int) Required FK Index, 26] }
        SELECT TOP(2) i.Id, i.Amount, i.CancelationReasons, i.ClientReferenceNumber, i.CreatedBy, i.CreatedDate, i.Currency, i.CustomerID, i.DiscountedPrimaryInvoiceID, i.DueAt, i.ExternalId, i.InvoiceNumber, i.InvoiceStatus, i.InvoiceType, i.IsDeleted, i.IsDiscounted, i.IsSubInvoice, i.IsSubstitution, i.IssuedAt, i.LastUpdatedDate, i.Metadata, i.PaymentProvider, i.PaymentReference, i.PrimaryInvoiceID, i.ProviderResponse, i.SubstitutionPrimaryInvoiceID, i.TenantId
        FROM Invoices AS i
        WHERE i.Id == @__entity_Id_0, 
        False, 
        new HashSet<string>(
            new string[]{ }, 
            StringComparer.Ordinal
        )
    )].GetRelationalCommandTemplate(parameters), 
    readerColumns: null, 
    shaper: (queryContext, dataReader, resultContext, resultCoordinator) => 
    {
        Invoice entity;
        entity = 
        {
            MaterializationContext materializationContext1;
            IEntityType entityType1;
            Invoice instance1;
            InternalEntityEntry entry1;
            bool hasNullKey1;
            materializationContext1 = new MaterializationContext(
                [LIFTABLE Constant: ValueBuffer | Resolver: _ => (object)ValueBuffer.Empty], 
                queryContext.Context
            );
            instance1 = default(Invoice);
            entry1 = queryContext.TryGetEntry(
                key: [LIFTABLE Constant: Key: Invoice.Id PK | Resolver: c => c.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice").FindPrimaryKey()], 
                keyValues: new object[]{ (object)dataReader.GetInt64(0) }, 
                throwOnNullKey: True, 
                hasNullKey: hasNullKey1);
            !(hasNullKey1) ? entry1 != default(InternalEntityEntry) ? 
            {
                entityType1 = entry1.EntityType;
                return instance1 = (Invoice)entry1.Entity;
            } : 
            {
                ISnapshot shadowSnapshot1;
                shadowSnapshot1 = [LIFTABLE Constant: Snapshot | Resolver: _ => Snapshot.Empty];
                entityType1 = [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{0} => namelessParameter{0}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")];
                instance1 = switch (entityType1)
                {
                    case [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{1} => namelessParameter{1}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]: 
                        {
                            return 
                            {
                                Invoice instance;
                                instance = new Invoice();
                                instance.<Id>k__BackingField = dataReader.GetInt64(0);
                                instance.<Amount>k__BackingField = dataReader.GetDecimal(1);
                                instance.<CancelationReasons>k__BackingField = dataReader.IsDBNull(2) ? default(string) : dataReader.GetString(2);
                                instance.<ClientReferenceNumber>k__BackingField = dataReader.IsDBNull(3) ? default(string) : dataReader.GetString(3);
                                instance.<CreatedBy>k__BackingField = dataReader.GetString(4);
                                instance.<CreatedDate>k__BackingField = dataReader.GetDateTime(5);
                                instance.<Currency>k__BackingField = dataReader.GetString(6);
                                instance.<CustomerId>k__BackingField = dataReader.GetInt64(7);
                                instance.<DiscountedPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(8) ? default(long?) : (long?)dataReader.GetInt64(8);
                                instance.<DueAt>k__BackingField = dataReader.IsDBNull(9) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(9);
                                instance.<ExternalId>k__BackingField = dataReader.GetGuid(10);
                                instance.<InvoiceNumber>k__BackingField = dataReader.GetString(11);
                                instance.<InvoiceStatus>k__BackingField = dataReader.GetInt32(12);
                                instance.<InvoiceType>k__BackingField = dataReader.GetInt32(13);
                                instance.<IsDeleted>k__BackingField = dataReader.GetBoolean(14);
                                instance.<IsDiscounted>k__BackingField = dataReader.IsDBNull(15) ? default(bool?) : (bool?)dataReader.GetBoolean(15);
                                instance.<IsSubInvoice>k__BackingField = dataReader.IsDBNull(16) ? default(bool?) : (bool?)dataReader.GetBoolean(16);
                                instance.<IsSubstitution>k__BackingField = dataReader.IsDBNull(17) ? default(bool?) : (bool?)dataReader.GetBoolean(17);
                                instance.<IssuedAt>k__BackingField = dataReader.GetDateTime(18);
                                instance.<LastUpdatedDate>k__BackingField = dataReader.IsDBNull(19) ? default(DateTime?) : (DateTime?)dataReader.GetDateTime(19);
                                instance.<Metadata>k__BackingField = dataReader.IsDBNull(20) ? default(string) : dataReader.GetString(20);
                                instance.<PaymentProvider>k__BackingField = dataReader.IsDBNull(21) ? default(string) : dataReader.GetString(21);
                                instance.<PaymentReference>k__BackingField = dataReader.IsDBNull(22) ? default(string) : dataReader.GetString(22);
                                instance.<PrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(23) ? default(long?) : (long?)dataReader.GetInt64(23);
                                instance.<ProviderResponse>k__BackingField = dataReader.IsDBNull(24) ? default(string) : dataReader.GetString(24);
                                instance.<SubstitutionPrimaryInvoiceId>k__BackingField = dataReader.IsDBNull(25) ? default(long?) : (long?)dataReader.GetInt64(25);
                                instance.<TenantId>k__BackingField = dataReader.GetInt32(26);
                                (instance is IInjectableService) ? ((IInjectableService)instance).Injected(
                                    context: materializationContext1.Context, 
                                    entity: instance, 
                                    queryTrackingBehavior: TrackAll, 
                                    structuralType: [LIFTABLE Constant: EntityType: Invoice | Resolver: namelessParameter{2} => namelessParameter{2}.Dependencies.Model.FindEntityType("BillingSystem.Domain.Entities.Invoice")]) : default(void);
                                return instance;
                            }}
                    default: 
                        default(Invoice)
                }
                ;
                entry1 = entityType1 == default(IEntityType) ? default(InternalEntityEntry) : queryContext.StartTracking(
                    entityType: entityType1, 
                    entity: instance1, 
                    snapshot: shadowSnapshot1);
                return instance1;
            } : default(void);
            return instance1;
        };
        return entity;
    }, 
    contextType: BillingSystem.Infrastructure.EF.BillingServiceDBContext, 
    standAloneStateManager: False, 
    detailedErrorsEnabled: False, 
    threadSafetyChecksEnabled: True)
    .SingleOrDefault()'
2025-11-19 12:58:05.380 +03:00 [DBG] Creating DbConnection.
2025-11-19 12:58:05.421 +03:00 [DBG] Created DbConnection. (40ms).
2025-11-19 12:58:05.430 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:05.794 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:05.803 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:58:05.815 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (8ms).
2025-11-19 12:58:05.829 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (26ms).
2025-11-19 12:58:05.845 +03:00 [DBG] Executing DbCommand [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:58:05.912 +03:00 [INF] Executed DbCommand (66ms) [Parameters=[@__entity_Id_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(2) [i].[Id], [i].[Amount], [i].[CancelationReasons], [i].[ClientReferenceNumber], [i].[CreatedBy], [i].[CreatedDate], [i].[Currency], [i].[CustomerID], [i].[DiscountedPrimaryInvoiceID], [i].[DueAt], [i].[ExternalId], [i].[InvoiceNumber], [i].[InvoiceStatus], [i].[InvoiceType], [i].[IsDeleted], [i].[IsDiscounted], [i].[IsSubInvoice], [i].[IsSubstitution], [i].[IssuedAt], [i].[LastUpdatedDate], [i].[Metadata], [i].[PaymentProvider], [i].[PaymentReference], [i].[PrimaryInvoiceID], [i].[ProviderResponse], [i].[SubstitutionPrimaryInvoiceID], [i].[TenantId]
FROM [Invoices] AS [i]
WHERE [i].[Id] = @__entity_Id_0
2025-11-19 12:58:05.984 +03:00 [DBG] Context 'BillingServiceDBContext' started tracking 'Invoice' entity. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:58:06.065 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.078 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 151ms reading results.
2025-11-19 12:58:06.085 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.096 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (10ms).
2025-11-19 12:58:06.189 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Unchanged"' to '"Modified"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:58:06.210 +03:00 [DBG] SaveChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:58:06.217 +03:00 [DBG] DetectChanges starting for 'BillingServiceDBContext'.
2025-11-19 12:58:06.225 +03:00 [DBG] DetectChanges completed for 'BillingServiceDBContext'.
2025-11-19 12:58:06.308 +03:00 [DBG] Opening connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.320 +03:00 [DBG] Opened connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.335 +03:00 [DBG] Creating DbCommand for 'ExecuteReader'.
2025-11-19 12:58:06.341 +03:00 [DBG] Created DbCommand for 'ExecuteReader' (6ms).
2025-11-19 12:58:06.352 +03:00 [DBG] Initialized DbCommand for 'ExecuteReader' (16ms).
2025-11-19 12:58:06.357 +03:00 [DBG] Executing DbCommand [Parameters=[@p8='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime), @p4='?' (DbType = DateTime), @p5='?' (Size = 100), @p6='?' (Size = 100), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [DueAt] = @p1, [InvoiceStatus] = @p2, [IssuedAt] = @p3, [LastUpdatedDate] = @p4, [PaymentProvider] = @p5, [PaymentReference] = @p6, [ProviderResponse] = @p7
OUTPUT 1
WHERE [Id] = @p8;
2025-11-19 12:58:06.439 +03:00 [INF] Executed DbCommand (82ms) [Parameters=[@p8='?' (DbType = Int64), @p0='?' (DbType = DateTime), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime), @p4='?' (DbType = DateTime), @p5='?' (Size = 100), @p6='?' (Size = 100), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Invoices] SET [CreatedDate] = @p0, [DueAt] = @p1, [InvoiceStatus] = @p2, [IssuedAt] = @p3, [LastUpdatedDate] = @p4, [PaymentProvider] = @p5, [PaymentReference] = @p6, [ProviderResponse] = @p7
OUTPUT 1
WHERE [Id] = @p8;
2025-11-19 12:58:06.467 +03:00 [DBG] Closing data reader to 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.478 +03:00 [DBG] A data reader for 'GAC-BillingService' on server '.' is being disposed after spending 30ms reading results.
2025-11-19 12:58:06.493 +03:00 [DBG] Closing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.500 +03:00 [DBG] Closed connection to database 'GAC-BillingService' on server '.' (6ms).
2025-11-19 12:58:06.520 +03:00 [DBG] An entity of type 'Invoice' tracked by 'BillingServiceDBContext' changed state from '"Modified"' to '"Unchanged"'. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see key values.
2025-11-19 12:58:06.537 +03:00 [DBG] SaveChanges completed for 'BillingServiceDBContext' with 1 entities written to the database.
2025-11-19 12:58:06.582 +03:00 [DBG] 'BillingServiceDBContext' disposed.
2025-11-19 12:58:06.593 +03:00 [DBG] Disposing connection to database 'GAC-BillingService' on server '.'.
2025-11-19 12:58:06.601 +03:00 [DBG] Disposed connection to database '' on server '' (8ms).
2025-11-19 12:58:11.449 +03:00 [INF] Processed message: invoice Id: 10015
